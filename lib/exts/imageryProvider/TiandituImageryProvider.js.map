{"version":3,"file":"TiandituImageryProvider.js","sources":["src/exts/imageryProvider/TiandituImageryProvider.js"],"sourcesContent":["import TiandituMapsStyle from './TiandituMapsStyle'\nconst TiandituMapsStyleUrl = {}\nconst TiandituMapsStyleLayer = {}\nconst TiandituMapsStyleID = {}\nconst TiandituMapsStyleFormat = {}\nconst TiandituMapsStyleEPSG = {}\nconst TiandituMapsStyleLabels = {}\n\nclass TiandituImageryProvider {\n  constructor (options) {\n    Object.keys(TiandituMapsStyle).forEach(key => {\n      TiandituMapsStyleUrl[TiandituMapsStyle[key]] = options.protocol + '://{s}.tianditu.gov.cn/' + TiandituMapsStyle[key] + '/wmts'\n      TiandituMapsStyleLayer[TiandituMapsStyle[key]] = TiandituMapsStyle[key].slice(0, 3)\n      TiandituMapsStyleID[TiandituMapsStyle[key]] = TiandituMapsStyle[key].slice(4)\n      TiandituMapsStyleFormat[TiandituMapsStyle[key]] = 'tiles'\n\n      if (TiandituMapsStyleID[TiandituMapsStyle[key]] === 'w') {\n        TiandituMapsStyleEPSG[TiandituMapsStyle[key]] = '900913'\n      } else {\n        TiandituMapsStyleEPSG[TiandituMapsStyle[key]] = '4490'\n      }\n      switch (TiandituMapsStyle[key]) {\n        case 'img_w':\n        case 'img_c':\n        case 'cia_w':\n        case 'cia_c':\n        case 'cta_w':\n        case 'cta_c':\n          TiandituMapsStyleLabels[TiandituMapsStyle[key]] = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18']\n          break\n        case 'vec_w':\n        case 'vec_c':\n        case 'cva_w':\n        case 'cva_c':\n          TiandituMapsStyleLabels[TiandituMapsStyle[key]] = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19']\n          break\n        case 'ter_w':\n        case 'ter_c':\n          TiandituMapsStyleLabels[TiandituMapsStyle[key]] = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12', '13', '14']\n          break\n        case 'eia_w':\n        case 'eia_c':\n        case 'eva_w':\n        case 'eva_c':\n        case 'ibo_c':\n        case 'ibo_w':\n          TiandituMapsStyleLabels[TiandituMapsStyle[key]] = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']\n          break\n      }\n    })\n    const { Credit, defaultValue, Event, GeographicTilingScheme, WebMercatorTilingScheme, when } = Cesium\n    options = defaultValue(options, {})\n    this._mapStyle = defaultValue(options.mapStyle, TiandituMapsStyle.IMG_W)\n    this._url = options.url || defaultValue(options.url, TiandituMapsStyleUrl[this._mapStyle])\n    this._token = options.token\n    this._layer = defaultValue(options.layer, TiandituMapsStyleLayer[this._mapStyle])\n    this._style = defaultValue(options.style, 'default')\n    this._tileMatrixSetID = defaultValue(options.tileMatrixSetID, TiandituMapsStyleID[this._mapStyle])\n    this._tileMatrixLabels = defaultValue(options.tileMatrixLabels, TiandituMapsStyleLabels[this._mapStyle])\n    this._format = defaultValue(options.format, TiandituMapsStyleFormat[this._mapStyle])\n    this._epsgCode = TiandituMapsStyleEPSG[this._mapStyle]\n    this._tilingScheme = this._epsgCode === '900913' ? new WebMercatorTilingScheme() : new GeographicTilingScheme()\n    this._tileWidth = defaultValue(options.tileWidth, 256)\n    this._tileHeight = defaultValue(options.tileHeight, 256)\n    this._minimumLevel = defaultValue(options.minimumLevel, 0)\n    this._maximumLevel = defaultValue(options.maximumLevel, TiandituMapsStyleLabels[this._mapStyle].length)\n    this._rectangle = defaultValue(options.rectangle, this.tilingScheme.rectangle)\n    this._readyPromise = when.resolve(true)\n    this._errorEvent = new Event()\n    const credit = defaultValue(options.credit, '天地图全球影像服务')\n    this._credit = typeof credit === 'string' ? new Credit(credit) : credit\n    this._subdomains = defaultValue(options.subdomains, ['t0', 't1', 't2', 't3', 't4', 't5', 't6', 't7'])\n    this._tileDiscardPolicy = options.tileDiscardPolicy\n  }\n\n  requestImage (x, y, level) {\n    const url = buildImageResource.call(this, x, y, level)\n    return Cesium.ImageryProvider.loadImage(this, url)\n  }\n\n  pickFeatures () { }\n\n  get url () {\n    return this._url\n  }\n\n  get mapStyle () {\n    return this._mapStyle\n  }\n\n  get tileWidth () {\n    return this._tileWidth\n  }\n\n  get tileHeight () {\n    return this._tileHeight\n  }\n\n  get maximumLevel () {\n    return this._maximumLevel\n  }\n\n  get minimumLevel () {\n    return this._minimumLevel\n  }\n\n  get tilingScheme () {\n    return this._tilingScheme\n  }\n\n  get rectangle () {\n    return this._rectangle\n  }\n\n  get errorEvent () {\n    return this._errorEvent\n  }\n\n  get ready () {\n    return true\n  }\n\n  get readyPromise () {\n    return this._readyPromise\n  }\n\n  get credit () {\n    return this._credit\n  }\n\n  get hasAlphaChannel () {\n    return true\n  }\n\n  get tileDiscardPolicy () {\n    return this._tileDiscardPolicy\n  }\n}\n\n/**\n * 构建天地图影像服务url, 调用时需要改变 this 指向为 TiandituImageryProvider\n * @param {number} x\n * @param {number} y\n * @param {number} level\n * @private\n */\nfunction buildImageResource (x, y, level) {\n  const { combine, defined, defaultValue, queryToObject, objectToQuery, Uri } = Cesium\n  const freezeObject = Object.freeze || function () { }\n  const options = freezeObject({\n    service: 'WMTS',\n    version: '1.0.0',\n    request: 'GetTile'\n  })\n  this._epsgCode === '900913' && (level -= 1)\n  const tileMatrixLabels = this._tileMatrixLabels\n  const tileMatrixLabel = defined(tileMatrixLabels) ? tileMatrixLabels[level] : level.toString()\n  const subdomains = this._subdomains\n  let url = this._url.replace('{s}', subdomains[(x + y + level) % subdomains.length])\n  const uri = new Uri(url)\n  let obj = queryToObject(defaultValue(uri.query?.(), ''))\n  obj = combine(options, obj)\n  obj.tilematrix = tileMatrixLabel\n  obj.layer = this._layer\n  obj.style = this._style\n  obj.tilerow = y\n  obj.tilecol = x\n  obj.tilematrixset = this._tileMatrixSetID\n  obj.format = this._format\n  const query = objectToQuery(obj)\n  url = uri.toString() + '?' + query\n  defined(this._proxy) && (url = this._proxy.getURL(url))\n  defined(this._token) && (url += '&tk=' + this._token)\n  return url\n}\n\nexport default TiandituImageryProvider\n"],"names":["TiandituMapsStyleUrl","TiandituMapsStyleLayer","TiandituMapsStyleID","TiandituMapsStyleFormat","TiandituMapsStyleEPSG","TiandituMapsStyleLabels","TiandituImageryProvider","options","TiandituMapsStyle","forEach","key","protocol","slice","Cesium","Credit","defaultValue","Event","GeographicTilingScheme","WebMercatorTilingScheme","when","_mapStyle","mapStyle","IMG_W","_url","url","_token","token","_layer","layer","_style","style","_tileMatrixSetID","tileMatrixSetID","_tileMatrixLabels","tileMatrixLabels","_format","format","_epsgCode","_tilingScheme","_tileWidth","tileWidth","_tileHeight","tileHeight","_minimumLevel","minimumLevel","_maximumLevel","maximumLevel","length","_rectangle","rectangle","tilingScheme","_readyPromise","resolve","_errorEvent","credit","_credit","_subdomains","subdomains","_tileDiscardPolicy","tileDiscardPolicy","x","y","level","buildImageResource","call","ImageryProvider","loadImage","combine","defined","queryToObject","objectToQuery","Uri","freezeObject","service","version","request","tileMatrixLabel","toString","replace","uri","obj","query","tilematrix","tilerow","tilecol","tilematrixset","_proxy","getURL"],"mappings":"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"}