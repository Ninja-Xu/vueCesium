{"version":3,"file":"particleSystem.js","sources":["src/exts/wind/particleSystem.js"],"sourcesContent":["import ParticlesComputing from './particlesComputing'\nimport ParticlesRendering from './particlesRendering'\n\nclass ParticleSystem {\n  constructor (context, data, particleSystemOptions, viewerParameters) {\n    this.context = context\n    this.data = data\n    this.particleSystemOptions = particleSystemOptions\n    this.viewerParameters = viewerParameters\n\n    this.particlesComputing = new ParticlesComputing(\n      this.context,\n      this.data,\n      this.particleSystemOptions,\n      this.viewerParameters\n    )\n    this.particlesRendering = new ParticlesRendering(\n      this.context,\n      this.data,\n      this.particleSystemOptions,\n      this.viewerParameters,\n      this.particlesComputing\n    )\n  }\n\n  canvasResize (context) {\n    this.particlesComputing.destroyParticlesTextures()\n    Object.keys(this.particlesComputing.windTextures).forEach(key => {\n      this.particlesComputing.windTextures[key].destroy()\n    })\n\n    this.particlesRendering.textures.colorTable.destroy()\n    Object.keys(this.particlesRendering.framebuffers).forEach(key => {\n      this.particlesRendering.framebuffers[key].destroy()\n    })\n\n    this.context = context\n    this.particlesComputing = new ParticlesComputing(\n      this.context,\n      this.data,\n      this.particleSystemOptions,\n      this.viewerParameters\n    )\n    this.particlesRendering = new ParticlesRendering(\n      this.context,\n      this.data,\n      this.particleSystemOptions,\n      this.viewerParameters,\n      this.particlesComputing\n    )\n  }\n\n  clearFramebuffers () {\n    const clearCommand = new Cesium.ClearCommand({\n      color: new Cesium.Color(0.0, 0.0, 0.0, 0.0),\n      depth: 1.0,\n      framebuffer: undefined,\n      pass: Cesium.Pass.OPAQUE\n    })\n\n    Object.keys(this.particlesRendering.framebuffers).forEach(key => {\n      clearCommand.framebuffer = this.particlesRendering.framebuffers[key]\n      clearCommand.execute(this.context)\n    })\n  }\n\n  refreshParticles (maxParticlesChanged) {\n    this.clearFramebuffers()\n\n    this.particlesComputing.destroyParticlesTextures()\n    this.particlesComputing.createParticlesTextures(\n      this.context,\n      this.particleSystemOptions,\n      this.viewerParameters\n    )\n\n    if (maxParticlesChanged) {\n      const geometry = this.particlesRendering.createSegmentsGeometry(\n        this.particleSystemOptions\n      )\n      this.particlesRendering.primitives.segments.geometry = geometry\n      const vertexArray = Cesium.VertexArray.fromGeometry({\n        context: this.context,\n        geometry: geometry,\n        attributeLocations: this.particlesRendering.primitives.segments\n          .attributeLocations,\n        bufferUsage: Cesium.BufferUsage.STATIC_DRAW\n      })\n      this.particlesRendering.primitives.segments.commandToExecute.vertexArray = vertexArray\n    }\n  }\n\n  applyParticleSystemOptions (particleSystemOptions) {\n    let maxParticlesChanged = false\n    if (\n      this.particleSystemOptions.maxParticles !==\n      particleSystemOptions.maxParticles\n    ) {\n      maxParticlesChanged = true\n    }\n\n    Object.keys(particleSystemOptions).forEach(key => {\n      this.particleSystemOptions[key] = particleSystemOptions[key]\n    })\n    this.refreshParticles(maxParticlesChanged)\n  }\n\n  applyViewerParameters (viewerParameters) {\n    Object.keys(viewerParameters).forEach(key => {\n      this.viewerParameters[key] = viewerParameters[key]\n    })\n    this.refreshParticles(false)\n  }\n}\n\nexport default ParticleSystem\n"],"names":["ParticleSystem","context","data","particleSystemOptions","viewerParameters","particlesComputing","ParticlesComputing","particlesRendering","ParticlesRendering","destroyParticlesTextures","windTextures","forEach","key","destroy","textures","colorTable","framebuffers","clearCommand","Cesium","ClearCommand","color","Color","depth","framebuffer","undefined","pass","Pass","OPAQUE","execute","maxParticlesChanged","clearFramebuffers","createParticlesTextures","geometry","createSegmentsGeometry","primitives","segments","vertexArray","VertexArray","fromGeometry","attributeLocations","bufferUsage","BufferUsage","STATIC_DRAW","commandToExecute","maxParticles","refreshParticles"],"mappings":"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"}