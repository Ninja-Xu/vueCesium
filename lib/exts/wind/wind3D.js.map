{"version":3,"file":"wind3D.js","sources":["src/exts/wind/wind3D.js"],"sourcesContent":["/**\n  @license\n  3D-Wind-Field - https://github.com/RaymanNg/3D-Wind-Field\n\n  Copyright (c) 2019 RaymanNg\n\n * Visualize the wind on earth, powered by Cesium JS.\n *\n * Licensed under the MIT License at:\n * http://www.opensource.org/licenses/mit-license.php\n *\n * @version -\n */\n\nimport ParticleSystem from './particleSystem'\nimport Util from './util'\nclass Wind3D {\n  constructor (viewer, data, particleSystemOptions) {\n    this.viewer = viewer\n    this.scene = this.viewer.scene\n    this.camera = this.viewer.camera\n    this.data = data\n    this.viewerParameters = {\n      lonRange: new Cesium.Cartesian2(),\n      latRange: new Cesium.Cartesian2(),\n      pixelSize: 0.0,\n      lonDataRange: new Cesium.Cartesian2(),\n      latDataRange: new Cesium.Cartesian2()\n    }\n    // use a smaller earth radius to make sure distance to camera > 0\n    this.globeBoundingSphere = new Cesium.BoundingSphere(\n      Cesium.Cartesian3.ZERO,\n      0.99 * 6378137.0\n    )\n    this.updateViewerParameters()\n    this.particleSystem = new ParticleSystem(\n      this.scene.context,\n      data,\n      particleSystemOptions,\n      this.viewerParameters\n    )\n\n    this.addPrimitives()\n    this.setupEventListeners()\n    this.imageryLayers = this.viewer.imageryLayers\n  }\n\n  addPrimitives () {\n    // the order of primitives.add() should respect the dependency of primitives\n    this.scene.primitives.add(\n      this.particleSystem.particlesComputing.primitives.getWind\n    )\n    this.scene.primitives.add(\n      this.particleSystem.particlesComputing.primitives.updateSpeed\n    )\n    this.scene.primitives.add(\n      this.particleSystem.particlesComputing.primitives.updatePosition\n    )\n    this.scene.primitives.add(\n      this.particleSystem.particlesComputing.primitives.postProcessingPosition\n    )\n    this.scene.primitives.add(\n      this.particleSystem.particlesComputing.primitives.postProcessingSpeed\n    )\n\n    this.scene.primitives.add(\n      this.particleSystem.particlesRendering.primitives.segments\n    )\n    this.scene.primitives.add(\n      this.particleSystem.particlesRendering.primitives.trails\n    )\n    this.scene.primitives.add(\n      this.particleSystem.particlesRendering.primitives.screen\n    )\n  }\n\n  removePrimitives () {\n    this.scene.primitives.remove(\n      this.particleSystem.particlesRendering.primitives.screen\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesRendering.primitives.trails\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesRendering.primitives.segments\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesComputing.primitives.postProcessingSpeed\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesComputing.primitives.postProcessingPosition\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesComputing.primitives.updatePosition\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesComputing.primitives.updateSpeed\n    )\n    this.scene.primitives.remove(\n      this.particleSystem.particlesComputing.primitives.getWind\n    )\n  }\n\n  updateViewerParameters () {\n    const viewRectangle = this.camera.computeViewRectangle(\n      this.scene.globe.ellipsoid\n    )\n    const lonLatRange = Util.viewRectangleToLonLatRange(viewRectangle)\n    this.viewerParameters.lonRange.x = lonLatRange.lon.min\n    this.viewerParameters.lonRange.y = lonLatRange.lon.max\n    this.viewerParameters.latRange.x = lonLatRange.lat.min\n    this.viewerParameters.latRange.y = lonLatRange.lat.max\n\n    this.viewerParameters.lonDataRange.x = this.data.lon.min\n    this.viewerParameters.lonDataRange.y = this.data.lon.max\n    this.viewerParameters.latDataRange.x = this.data.lat.min\n    this.viewerParameters.latDataRange.y = this.data.lat.max\n\n    const pixelSize = this.camera.getPixelSize(\n      this.globeBoundingSphere,\n      this.scene.drawingBufferWidth,\n      this.scene.drawingBufferHeight\n    )\n\n    if (pixelSize > 0) {\n      this.viewerParameters.pixelSize = pixelSize\n    }\n  }\n\n  moveStartListener () {\n    this.scene.primitives.show = false\n  }\n\n  moveEndListener () {\n    this.updateViewerParameters()\n    this.particleSystem.applyViewerParameters(this.viewerParameters)\n    this.scene.primitives.show = true\n  }\n\n  preRenderListener () {\n    if (this.resized) {\n      this.particleSystem.canvasResize(this.scene.context)\n      this.resized = false\n      this.addPrimitives()\n      this.scene.primitives.show = true\n    }\n  }\n\n  setupEventListeners () {\n    const that = this\n\n    this.camera.moveStart.addEventListener(this.moveStartListener, this)\n    this.camera.moveEnd.addEventListener(this.moveEndListener, this)\n\n    this.resized = false\n    window.addEventListener('resize', function () {\n      that.resized = true\n      that.scene.primitives.show = false\n      that.scene.primitives.removeAll()\n    })\n\n    this.scene.preRender.addEventListener(this.preRenderListener, this)\n  }\n\n  destroy () {\n    this.removePrimitives()\n    this.camera.moveStart.removeEventListener(this.moveStartListener, this)\n    this.camera.moveEnd.removeEventListener(this.moveEndListener, this)\n    this.scene.preRender.removeEventListener(this.preRenderListener, this)\n  }\n}\n\nexport default Wind3D\n"],"names":["Wind3D","viewer","data","particleSystemOptions","scene","camera","viewerParameters","lonRange","Cesium","Cartesian2","latRange","pixelSize","lonDataRange","latDataRange","globeBoundingSphere","BoundingSphere","Cartesian3","ZERO","updateViewerParameters","particleSystem","ParticleSystem","context","addPrimitives","setupEventListeners","imageryLayers","primitives","add","particlesComputing","getWind","updateSpeed","updatePosition","postProcessingPosition","postProcessingSpeed","particlesRendering","segments","trails","screen","remove","viewRectangle","computeViewRectangle","globe","ellipsoid","lonLatRange","Util","viewRectangleToLonLatRange","x","lon","min","y","max","lat","getPixelSize","drawingBufferWidth","drawingBufferHeight","show","applyViewerParameters","resized","canvasResize","that","moveStart","addEventListener","moveStartListener","moveEnd","moveEndListener","window","removeAll","preRender","preRenderListener","removePrimitives","removeEventListener"],"mappings":"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"}