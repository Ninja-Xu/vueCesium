{"version":3,"file":"mixinDatasource.js","sources":["src/mixins/datasource/mixinDatasource.js"],"sourcesContent":["import { differenceBy } from 'lodash-es'\nimport bindEvents from '../../utils/bindEvent'\nimport { Events } from '../../utils/events'\nimport cmp from '../virtualCmp'\nimport mixinPickEvent from '../event/mixinPickEvent'\nimport { show } from '../mixinProps'\nimport mergeDescriptors from '../../utils/mergeDescriptors'\n\nconst watch = {\n  entities: {\n    /**\n     * https://cn.vuejs.org/v2/guide/reactivity.html#检测变化的注意事项\n     */\n    handler: function (newVal, oldVal) {\n      if (!this.mounted) {\n        return\n      }\n      const { transformProp, transformProps, datasource } = this\n      if (newVal === oldVal) {\n        if (newVal.length === datasource.entities.values.length) {\n          // 认为是修改了某个对象\n          for (let i = 0; i < newVal.length; i++) {\n            const options = newVal[i]\n            Object.keys(options).forEach(prop => {\n              if (prop !== 'id') {\n                datasource.entities.values[i][prop] = transformProp(prop, options[prop])\n              }\n            })\n          }\n        } else if (newVal.length > datasource.entities.values.length) {\n          // 认为是插入了新对象 push unshift splice\n          const addedEntities = differenceBy(newVal, datasource.entities.values, 'id')\n          if (addedEntities.length === 0) {\n            // warn 请使用唯一 id\n          }\n          for (let i = 0; i < addedEntities.length; i++) {\n            const entityOptions = addedEntities[i]\n            const entityOptionsTransform = transformProps(entityOptions)\n            const entityAdded = datasource.entities.add(entityOptionsTransform)\n            entityAdded.vcIndex = newVal.indexOf(entityOptions)\n            entityAdded.id !== entityOptions.id && (entityOptions.id = entityAdded.id)\n          }\n        } else if (newVal.length < datasource.entities.values.length) {\n          // 认为是删除了对象 pop splice shift\n          const deletedEntities = differenceBy(datasource.entities.values, newVal, 'id')\n          for (let i = 0; i < deletedEntities.length; i++) {\n            const entity = deletedEntities[i]\n            datasource.entities.remove(entity)\n          }\n          let iNull = 0\n          for (let i = 0; i < datasource.entities.values.length; i++) {\n            if (datasource.entities.values[i]) {\n              datasource.entities.values[i].vcIndex = i - iNull\n            } else {\n              iNull++\n            }\n          }\n        }\n      } else {\n        // 认为是赋新值\n        this.reload()\n      }\n    },\n    deep: true\n  }\n}\nconst methods = {\n  async mount () {\n    const { dataSources, datasource, registerEvents, entities, transformProps } = this\n    bindEvents.call(this, datasource, Events['datasource-events'], true)\n    Events['datasource-property-events'].forEach((eventName) => {\n      datasource[eventName.name] && bindEvents.call(this, datasource[eventName.name], eventName.events, true)\n    })\n    datasource.show = this.show\n    registerEvents(true)\n    for (let i = 0; i < entities.length; i++) {\n      const entityOptions = entities[i]\n      const entityOptionsTransform = transformProps(entityOptions)\n      const entity = datasource.entities.add(entityOptionsTransform)\n      entity.vcIndex = i\n      entityOptions.id !== entity.id && (entityOptions.id = entity.id)\n    }\n\n    return dataSources.add(datasource).then(() => {\n      return true\n    })\n  },\n  async unmount () {\n    const { dataSources, datasource, registerEvents } = this\n    bindEvents.call(this, datasource, Events['datasource-events'], false)\n    Events['datasource-property-events'].forEach((eventName) => {\n      datasource[eventName.name] && bindEvents.call(this, datasource[eventName.name], eventName.events, false)\n    })\n    registerEvents(false)\n    return dataSources && dataSources.remove(datasource)\n  },\n  getServices () {\n    const vm = this\n    return mergeDescriptors(cmp.methods.getServices.call(this), {\n      get datasource () {\n        return vm.datasource\n      },\n      get entities () {\n        return vm.datasource.entities\n      }\n    })\n  }\n}\nexport default {\n  mixins: [cmp, show, mixinPickEvent],\n  methods,\n  props: {\n    enableEvent: {\n      type: Boolean,\n      default: true\n    },\n    entities: {\n      type: Array,\n      default: () => []\n    }\n  },\n  watch,\n  stubVNode: {\n    attrs () {\n      return {\n        class: this.$options.name\n      }\n    }\n  },\n  created () {\n    Object.defineProperties(this, {\n      datasource: {\n        enumerable: true,\n        get: () => this.cesiumObject\n      },\n      dataSources: {\n        enumerable: true,\n        get: () => this.$services && this.$services.dataSources\n      }\n    })\n  }\n}\n"],"names":["watch","entities","handler","newVal","oldVal","mounted","transformProp","transformProps","datasource","length","values","i","options","forEach","prop","addedEntities","differenceBy","entityOptions","entityOptionsTransform","entityAdded","add","vcIndex","indexOf","id","deletedEntities","entity","remove","iNull","reload","deep","methods","mount","dataSources","registerEvents","bindEvents","call","Events","eventName","name","events","show","then","unmount","getServices","vm","mergeDescriptors","cmp","mixins","mixinPickEvent","props","enableEvent","type","Boolean","default","Array","stubVNode","attrs","class","$options","created","Object","defineProperties","enumerable","get","cesiumObject","$services"],"mappings":"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"}