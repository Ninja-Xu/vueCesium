{"version":3,"file":"mixinPickEvent.js","sources":["src/mixins/event/mixinPickEvent.js"],"sourcesContent":["import { isArray } from '../../utils/util.js'\nimport { Events } from '../../utils/events'\nconst methods = {\n  registerEvents (flag) {\n    const { viewer, cesiumObject, enableEvent } = this\n    const that = this\n    if (flag && enableEvent) {\n      if (!this.$vc._screenSpaceEventHandler) {\n        this.$vc._screenSpaceEventHandler = new Cesium.ScreenSpaceEventHandler(viewer.canvas)\n        const handler = this.$vc._screenSpaceEventHandler\n        Events['viewer-mouse-events'].forEach((eventName) => {\n          handler.setInputAction(action.bind({ eventName, viewer }), Cesium.ScreenSpaceEventType[eventName])\n        })\n      }\n      Events['mouse-events'].forEach((eventName) => {\n        const listener = that.$listeners[eventName]\n        listener && (cesiumObject[eventName] = listener.fns)\n      })\n    } else {\n      Events['mouse-events'].forEach((eventName) => {\n        const listener = that.$listeners[eventName]\n        listener && delete cesiumObject[eventName]\n      })\n    }\n  }\n}\n\nexport default {\n  methods\n}\n\nfunction action (movement) {\n  const { viewer, eventName } = this\n  const position = movement.position || movement.endPosition\n  if (!position) {\n    return\n  }\n\n  const pickedFeatureAndCallbackNames = []\n\n  let callbackName\n  if (eventName.indexOf('LEFT_DOUBLE_CLICK') !== -1) {\n    callbackName = 'dblclick'\n  } else if (eventName.indexOf('CLICK') !== -1) {\n    callbackName = 'click'\n  } else if (eventName.indexOf('DOWN') !== -1) {\n    callbackName = 'mousedown'\n  } else if (eventName.indexOf('UP') !== -1) {\n    callbackName = 'mouseup'\n  } else if (eventName.indexOf('MOUSE_MOVE') !== -1) {\n    callbackName = 'mousemove'\n  }\n\n  let callbackNameOut\n  if (callbackName === 'mousemove') {\n    callbackNameOut = 'mouseout'\n  } else if (callbackName === 'click') {\n    callbackNameOut = 'clickout'\n  }\n\n  const pickedFeature = viewer.scene.pick(position)\n  if (!Cesium.defined(pickedFeature)) {\n    if (this.pickedFeature) { // 没有拾取到对象，this.pickedFeature又有记录，说明移出了。\n      pickedFeatureAndCallbackNames.push({\n        callbackName: callbackNameOut,\n        pickedFeature: this.pickedFeature\n      })\n    }\n\n    this.pickedFeature = undefined\n  } else {\n    if (this.pickedFeature && this.pickedFeature.id !== pickedFeature.id) {\n      pickedFeatureAndCallbackNames.push({ // 拾取到对象，this.pickedFeature也有记录，两者不同，说明操作到另外一个对象上去了\n        callbackName: callbackNameOut,\n        pickedFeature: this.pickedFeature\n      })\n    }\n    if (callbackName === 'mousemove' && (!this.pickedFeature || this.pickedFeature.id !== pickedFeature.id)) {\n      pickedFeatureAndCallbackNames.push({\n        callbackName: 'mouseover',\n        pickedFeature\n      })\n    }\n\n    pickedFeatureAndCallbackNames.push({\n      callbackName,\n      pickedFeature\n    })\n  }\n\n  if (pickedFeatureAndCallbackNames.length === 0) {\n    return\n  }\n\n  let intersection\n  const scene = viewer.scene\n  if (scene.mode === Cesium.SceneMode.SCENE3D) {\n    const ray = scene.camera.getPickRay(position)\n    intersection = scene.globe.pick(ray, scene)\n  } else {\n    intersection = scene.camera.pickEllipsoid(position, viewer.scene.globe.ellipsoid)\n  }\n\n  let button = -1\n  if (eventName.indexOf('LEFT') !== -1) {\n    button = 0\n  } else if (eventName.indexOf('MIDDLE') !== -1) {\n    button = 1\n  } else if (eventName.indexOf('RIGHT') !== -1) {\n    button = 2\n  }\n  const eventSourceList = []\n  pickedFeatureAndCallbackNames.forEach(item => {\n    const callbackName = item.callbackName\n    const pickedFeature = item.pickedFeature\n    if (pickedFeature.id) {\n      if (isArray(pickedFeature.id) && pickedFeature.id[0] instanceof Cesium.Entity) {\n      // 数据源集合（集群）\n        eventSourceList.push({\n          callbackName,\n          cesiumObject: pickedFeature.id[0].entityCollection.owner,\n          pickedFeature\n        })\n      } else if (pickedFeature.id instanceof Cesium.Entity) {\n      // 实体\n        eventSourceList.push({\n          callbackName,\n          cesiumObject: pickedFeature.id,\n          pickedFeature\n        })\n        // 数据源\n        eventSourceList.push({\n          callbackName,\n          cesiumObject: pickedFeature.id.entityCollection.owner,\n          pickedFeature\n        })\n      }\n    }\n    // 图元\n    if (pickedFeature.primitive) {\n      eventSourceList.push({\n        callbackName,\n        cesiumObject: pickedFeature.primitive,\n        pickedFeature\n      })\n    }\n\n    const getParentCollection = e => {\n      eventSourceList.push({\n        callbackName,\n        cesiumObject: e,\n        pickedFeature\n      })\n      if (e._vcParent) {\n        getParentCollection(e._vcParent)\n      }\n    }\n    // 图元集合\n    if (pickedFeature.collection) {\n      eventSourceList.push({\n        callbackName,\n        cesiumObject: pickedFeature.collection,\n        pickedFeature\n      })\n      if (pickedFeature.collection._vcParent) {\n        getParentCollection(pickedFeature.collection._vcParent)\n      }\n    }\n  })\n\n  eventSourceList.forEach(event => {\n    event.cesiumObject[event.callbackName] && event.cesiumObject[event.callbackName]({\n      type: `on${event.callbackName}`,\n      windowPosition: position,\n      surfacePosition: intersection,\n      pickedFeature: event.pickedFeature,\n      button,\n      cesiumObject: event.cesiumObject\n    })\n  })\n\n  this.pickedFeature = pickedFeature\n}\n"],"names":["methods","registerEvents","flag","viewer","cesiumObject","enableEvent","that","$vc","_screenSpaceEventHandler","Cesium","ScreenSpaceEventHandler","canvas","handler","Events","forEach","eventName","setInputAction","action","bind","ScreenSpaceEventType","listener","$listeners","fns","movement","position","endPosition","pickedFeatureAndCallbackNames","callbackName","indexOf","callbackNameOut","pickedFeature","scene","pick","defined","push","undefined","id","length","intersection","mode","SceneMode","SCENE3D","ray","camera","getPickRay","globe","pickEllipsoid","ellipsoid","button","eventSourceList","item","isArray","Entity","entityCollection","owner","primitive","getParentCollection","e","_vcParent","collection","event","type","windowPosition","surfacePosition"],"mappings":"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"}